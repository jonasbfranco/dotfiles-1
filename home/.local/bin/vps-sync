#!/usr/bin/env sh
#
# vps-sync
# LEMBRE-SE DE CONFIGURAR CORRETAMENTE SEU SSH SEM SENHA
#
# Desenvolvido por Lucas Saliés Brum <lucas@archlinux.com.br>
#
# Sugestão de crontab:
# */15 * * * * sh -c "~/.local/bin/git-cron" > /dev/null 2>&1
#
# Criado em: 15-03-2019 11:06:42
# Última Atualização: 15-03-2019 11:06:57

[ ! $1 ] && exit

host="$1"
dir="${HOME}/backup/$host"
remoto="nginx@hera"
icone="${HOME}/.local/share/icons/elementary/preferences-system-network.png"
som="complete"

alerta() {
	if xset q &>/dev/null; then
		dbus-launch canberra-gtk-play -i $som 2>&1
		dbus-launch notify-send -i $icone "$1" "$2"
	else
		echo "${1}: $2"
	fi
}

atualiza() {
	if [ -d $1 ]; then
		cd $1
		status=$(git add . -n)
		if [ ! -z "$status" ]; then
			c=$(echo $(git add . -n | tr '\r\n' ' '))
			m="Autocommit por Git-Cron: alterações: $c"
			git add .
			git commit -m "$m"
			git push
			if [ "$?" == 0 ]; then
				alerta "Git Cron" "Repo <b>$(basename $1)</b> atualizado."
				[ -f /tmp/git-cron.error ] && rm /tmp/git-cron.error
			else
				if [ ! -f /tmp/git-cron.error ]; then
					icone="${HOME}/.local/share/icons/elementary/network-error.png"
					som="dialog-warning"
					alerta "Git Cron" "Erro ao atualizar <b>$(basename $1)</b>."
					touch /tmp/git-cron.error
				fi
			fi
		fi
	fi
}

if [ ! $1 ] || [ "$1" == "-a" ]; then
	for r in "${repos[@]}";	do
		caminho="${dir}/${r}"
		atualiza "$caminho"
	done
elif [ ! $2 ]; then
	atualiza "$1"
else
	for r in "$@";	do
		caminho="${dir}/${r}"
		atualiza "$caminho"
	done
fi

